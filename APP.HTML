from fastapi import FastAPI, HTTPException
from pydantic import BaseModel
from typing import List, Optional
from datetime import datetime

app = FastAPI(title="Healthcare Appointment System")

# ---------- Models ----------
class Patient(BaseModel):
    id: int
    name: str
    age: int
    language: str
    health_condition: Optional[str] = None

class Doctor(BaseModel):
    id: int
    name: str
    specialization: str
    available_slots: List[str]  # ["2025-09-21 10:00", "2025-09-21 11:00"]

class Appointment(BaseModel):
    id: int
    patient_id: int
    doctor_id: int
    slot: str
    status: str = "Booked"

# ---------- Fake Database ----------
patients_db: List[Patient] = []
doctors_db: List[Doctor] = []
appointments_db: List[Appointment] = []

# ---------- Endpoints ----------

@app.post("/patient/register")
def register_patient(patient: Patient):
    patients_db.append(patient)
    return {"message": "Patient registered successfully", "patient": patient}

@app.post("/doctor/register")
def register_doctor(doctor: Doctor):
    doctors_db.append(doctor)
    return {"message": "Doctor registered successfully", "doctor": doctor}

@app.get("/doctor/availability/{doctor_id}")
def get_doctor_availability(doctor_id: int):
    for doc in doctors_db:
        if doc.id == doctor_id:
            return {"doctor": doc.name, "available_slots": doc.available_slots}
    raise HTTPException(status_code=404, detail="Doctor not found")

@app.post("/appointment/book")
def book_appointment(appointment: Appointment):
    # Check if slot is available
    for doc in doctors_db:
        if doc.id == appointment.doctor_id:
            if appointment.slot not in doc.available_slots:
                raise HTTPException(status_code=400, detail="Slot not available")
            doc.available_slots.remove(appointment.slot)
            appointments_db.append(appointment)
            return {"message": "Appointment booked", "appointment": appointment}
    raise HTTPException(status_code=404, detail="Doctor not found")

@app.put("/appointment/reschedule/{appointment_id}")
def reschedule_appointment(appointment_id: int, new_slot: str):
    for appt in appointments_db:
        if appt.id == appointment_id:
            appt.slot = new_slot
            appt.status = "Rescheduled"
            return {"message": "Appointment rescheduled", "appointment": appt}
    raise HTTPException(status_code=404, detail="Appointment not found")

@app.delete("/appointment/cancel/{appointment_id}")
def cancel_appointment(appointment_id: int):
    for appt in appointments_db:
        if appt.id == appointment_id:
            appt.status = "Cancelled"
            return {"message": "Appointment cancelled", "appointment": appt}
    raise HTTPException(status_code=404, detail="Appointment not found")

@app.get("/patient/suggestions/{patient_id}")
def health_suggestions(patient_id: int):
    for pat in patients_db:
        if pat.id == patient_id:
            if pat.health_condition:
                if "fever" in pat.health_condition.lower():
                    return {"suggestion": "Take paracetamol, drink fluids, rest well."}
                elif "cold" in pat.health_condition.lower():
                    return {"suggestion": "Drink warm water, take vitamin C, rest."}
            return {"suggestion": "No specific condition, maintain healthy diet & exercise."}
    raise HTTPException(status_code=404, detail="Patient not found")